<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ°ç•¥é€£ç·šï¼šå› æœé­”æ³•ä¸–ç•Œç ´å†°ä»»å‹™</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+TC:wght@500;700;900&display=swap');

        :root { 
            --p1: #00f2fe; 
            --p2: #4facfe; 
            --accent: #ff007a; 
            --bg: #050a14; 
            --gold: #f9d423;
            --text-bright: #ffffff;
            --text-dim: #cbd5e1;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: var(--bg); 
            color: var(--text-dim); 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 20px 0;
            -webkit-text-size-adjust: 100%;
        }

        .container { 
            width: 94%; 
            max-width: 500px; 
            background: rgba(15, 23, 42, 0.96); 
            padding: 1.2rem; 
            border-radius: 24px; 
            border: 2px solid var(--p1); 
            box-shadow: 0 0 40px rgba(0, 242, 254, 0.2); 
            text-align: center;
            position: relative;
        }

        h1 { font-family: 'Orbitron'; font-size: 1.1rem; color: var(--text-bright); margin-bottom: 0.3rem; letter-spacing: 1px; }
        .subtitle { font-size: 0.7rem; color: var(--p1); margin-bottom: 0.8rem; letter-spacing: 1px; font-weight: 700; }

        .screen { display: none; }
        .active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .nav-bar { display: flex; justify-content: flex-start; margin-bottom: 8px; }
        .btn-back { color: #64748b; font-size: 0.75rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 5px; padding: 5px 0; transition: 0.2s; }
        .btn-back:hover { color: var(--p1); }

        /* è¡¨å–®å€åŸŸ */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; text-align: left; margin-bottom: 10px; }
        .form-item { text-align: left; margin-bottom: 6px; }
        .form-item label { display: block; font-size: 0.55rem; color: var(--p1); font-weight: 900; margin-bottom: 2px; font-family: 'Orbitron'; }
        
        .form-item input, .form-item textarea, .form-item select {
            width: 100%;
            background: #1e293b; 
            border: 1px solid rgba(0, 242, 254, 0.3);
            border-radius: 8px;
            padding: 8px;
            color: #fff;
            font-size: 0.8rem;
            font-family: inherit;
        }
        /* å¼·åˆ¶ä¿®æ­£ä¸‹æ‹‰é¸å–®å­—é«”åç™½ */
        .form-item select option { background: #1e293b; color: #ffffff; }
        .form-full { grid-column: span 2; }

        /* æ•¸ä½åç‰Œ */
        .crystal-card {
            background: linear-gradient(135deg, #1e293b, #050a14);
            border: 2px solid var(--p1);
            border-radius: 20px;
            padding: 12px;
            margin: 8px 0;
            text-align: left;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 242, 254, 0.2);
        }
        .info-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 5px; }
        .info-tag { font-size: 0.5rem; color: var(--p1); font-family: 'Orbitron'; font-weight: 900; opacity: 0.7; }
        .info-val { font-size: 0.75rem; color: #fff; font-weight: 700; }

        /* ä¸‰éšæ®µåŒæ­¥é€²åº¦ */
        .game-progress-bar { display: flex; gap: 6px; margin: 10px 0; justify-content: center; }
        .game-dot { width: 35px; height: 5px; background: rgba(255,255,255,0.1); border-radius: 3px; }
        .game-dot.fill { background: var(--gold); box-shadow: 0 0 8px var(--gold); }

        .game-box {
            background: rgba(249, 212, 35, 0.1);
            border: 2px solid var(--gold);
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
            color: var(--gold);
            font-weight: 900;
            font-size: 0.95rem;
            line-height: 1.5;
            text-align: left;
            position: relative;
            min-height: 115px;
            display: flex;
            align-items: center;
        }
        .game-box::before {
            content: "ğŸ² åŒæ­¥æŒ‘æˆ°ä»»å‹™";
            position: absolute; top: -10px; left: 10px;
            background: var(--gold); color: #000;
            font-size: 0.55rem; padding: 2px 8px; border-radius: 4px; font-weight: 900;
        }

        /* è§’è‰²é¸æ“‡ */
        .role-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0; }
        .role-item { 
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(0, 242, 254, 0.3); 
            padding: 10px; border-radius: 12px; cursor: pointer; text-align: left; min-height: 85px;
            transition: 0.2s;
        }
        .role-item.selected { background: var(--p1); border-color: #fff; color: #000; box-shadow: 0 0 15px var(--p1); }
        .role-name { font-weight: 900; font-size: 0.75rem; margin-bottom: 3px; display: block; }
        .role-desc { font-size: 0.55rem; color: #94a3b8; line-height: 1.2; }
        .role-item.selected .role-desc { color: #333; }

        /* å› æœæŒ‘æˆ° */
        .case-box { background: #000; padding: 12px; border-radius: 12px; border-left: 4px solid var(--accent); text-align: left; margin-bottom: 10px; }
        .case-tag { font-size: 0.55rem; color: var(--accent); font-weight: 900; font-family: 'Orbitron'; }
        .case-txt { font-size: 0.85rem; color: #fff; font-weight: 700; margin-top: 4px; line-height: 1.4; }

        .fragment-hint {
            background: linear-gradient(135deg, rgba(0, 242, 254, 0.1), rgba(255, 0, 122, 0.1));
            border: 2px dashed var(--p1);
            padding: 12px; border-radius: 15px; margin: 12px 0;
            text-align: left; font-size: 0.85rem; color: #fff; line-height: 1.4; font-weight: 700;
        }

        .btn-opt { 
            display: block; width: 100%; padding: 0.85rem; margin: 6px 0; 
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); 
            border-radius: 12px; color: #fff; text-align: center; cursor: pointer; 
            font-size: 0.8rem; font-weight: 700; line-height: 1.3; transition: 0.2s;
        }
        .btn-opt.selected { border-color: var(--gold); background: rgba(249, 212, 35, 0.2); box-shadow: 0 0 10px var(--gold); }

        .btn-cta { background: var(--gold); color: #000; border: none; padding: 0.9rem; border-radius: 12px; font-size: 0.95rem; font-weight: 900; width: 100%; cursor: pointer; margin-top: 15px; transition: 0.2s; }
        .btn-cta:disabled { opacity: 0.3; cursor: not-allowed; }

        #scanner-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 10, 20, 0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; border-radius: 24px; }
        .scan-line { width: 85%; height: 2px; background: var(--p1); box-shadow: 0 0 20px var(--p1); animation: scanLoop 1.5s ease-in-out infinite; }
        @keyframes scanLoop { 0%, 100% { transform: translateY(-40px); } 50% { transform: translateY(40px); } }
    </style>
</head>
<body>

<div class="container" id="app">
    <div id="scanner-ui"><div class="scan-line"></div><div style="margin-top:20px; font-family:'Orbitron'; color:var(--p1); font-weight:900;">AI ANALYZING...</div></div>

    <!-- ä»»å‹™ä¸€ï¼šå»ºç«‹é‡‘é‘° -->
    <div id="screen-1" class="screen active">
        <h1>IDENTITY KEY</h1>
        <div class="subtitle">ä»»å‹™ä¸€ï¼šå»ºç«‹å€‹äººå¤©è³¦é‡‘é‘°</div>
        
        <div class="form-grid">
            <div class="form-item form-full">
                <label>GROUP (åˆ†é…çµ„åˆ¥)</label>
                <select id="in-group">
                    <option value="A">A çµ„ (Group A)</option>
                    <option value="B">B çµ„ (Group B)</option>
                    <option value="C">C çµ„ (Group C)</option>
                    <option value="D">D çµ„ (Group D)</option>
                </select>
            </div>
            <div class="form-item"><label>NAME / FROM</label><input type="text" id="in-name" placeholder="æ—åŒå­¸ / å°åŒ—"></div>
            <div class="form-item"><label>MBTI TYPE</label><input type="text" id="in-mbti" placeholder="INTJ"></div>
            
            <div class="form-item">
                <label>SIBLINGS (æ‰‹è¶³æ’è¡Œ)</label>
                <select id="in-sibling">
                    <option value="ç¨ç”Ÿå­å¥³">ç¨ç”Ÿå­å¥³ (Only Child)</option>
                    <option value="æœ‰å“¥å“¥">æœ‰å“¥å“¥</option>
                    <option value="æœ‰å§Šå§Š">æœ‰å§Šå§Š</option>
                    <option value="æœ‰å¼Ÿå¼Ÿ">æœ‰å¼Ÿå¼Ÿ</option>
                    <option value="æœ‰å¦¹å¦¹">æœ‰å¦¹å¦¹</option>
                    <option value="è€å¤§ (æœ‰å¼Ÿå¦¹)">è€å¤§ (Eldest)</option>
                    <option value="è€ä¹ˆ (æœ‰å…„å§)">è€ä¹ˆ (Youngest)</option>
                    <option value="æ’è¡Œä¸­é–“">æ’è¡Œä¸­é–“ (Middle)</option>
                    <option value="é›™èƒèƒ">é›™èƒèƒ (Twin)</option>
                </select>
            </div>
            <div class="form-item">
                <label>LANGUAGES (æœƒè¬›å¹¾ç¨®)</label>
                <select id="in-language">
                    <option value="1ç¨®">1 ç¨®</option>
                    <option value="2ç¨®">2 ç¨®</option>
                    <option value="3ç¨®">3 ç¨®</option>
                    <option value="4ç¨®ä»¥ä¸Š">4 ç¨®ä»¥ä¸Š</option>
                </select>
            </div>

            <div class="form-item"><label>BEST SUBJECT</label><input type="text" id="in-subject" placeholder="ç”Ÿç‰© / æ•¸å­¸"></div>
            <div class="form-item">
                <label>INSTRUMENT</label>
                <select id="in-music">
                    <option value="æœ‰å­¸éæ¨‚å™¨">æœ‰å­¸é (Yes)</option>
                    <option value="æ²’å­¸éæ¨‚å™¨">æ²’å­¸é (No)</option>
                </select>
            </div>

            <div class="form-item form-full">
                <label>CLUB EXPERIENCE (ç¤¾åœ˜ç¶“é©—)</label>
                <select id="in-club">
                    <option value="é‹å‹•é¡ / æ’çƒ">é‹å‹•é¡ / æ’çƒ</option>
                    <option value="é‹å‹•é¡ / ç±ƒçƒ">é‹å‹•é¡ / ç±ƒçƒ</option>
                    <option value="é‹å‹•é¡ / ç¾½çƒ">é‹å‹•é¡ / ç¾½çƒ</option>
                    <option value="é‹å‹•é¡ / æ¡Œçƒ">é‹å‹•é¡ / æ¡Œçƒ</option>
                    <option value="é‹å‹•é¡ / æ¸¸æ³³">é‹å‹•é¡ / æ¸¸æ³³</option>
                    <option value="åº·è¼”é¡ / å‰ä»–">åº·è¼”é¡ / å‰ä»–</option>
                    <option value="åº·è¼”é¡ / ç†±èˆ">åº·è¼”é¡ / ç†±èˆ</option>
                    <option value="åº·è¼”é¡ / åº·è¼”ç¤¾">åº·è¼”é¡ / åº·è¼”ç¤¾</option>
                    <option value="å¿—å·¥é¡ / å¿—å·¥ç¤¾">å¿—å·¥é¡ / å¿—å·¥ç¤¾</option>
                    <option value="å­¸è¡“ / å­¸ç”Ÿæœƒ">å­¸è¡“ / å­¸ç”Ÿæœƒ</option>
                    <option value="æ²’åƒåŠ ç¤¾åœ˜">æ²’åƒåŠ ç¤¾åœ˜</option>
                </select>
            </div>

            <div class="form-item form-full"><label>INTEREST / HOBBY</label><input type="text" id="in-hobby" placeholder="ä½ å¹³æ™‚æœ€å–œæ­¡åšä»€éº¼ï¼Ÿ"></div>
            <div class="form-item form-full"><label>AWAKENING MOTIVE</label><textarea id="in-motive" placeholder="ç‚ºä»€éº¼å ±ååƒåŠ é€™æ¬¡ç‡ŸéšŠï¼Ÿ" style="height: 40px;"></textarea></div>
        </div>

        <button class="btn-cta" onclick="finishTask1()">åŒæ­¥ä¸¦ç”Ÿæˆé‡‘é‘°</button>
    </div>

    <!-- ä»»å‹™äºŒï¼šéˆé­‚åŒæ­¥ -->
    <div id="screen-2" class="screen">
        <div class="nav-bar"><div class="btn-back" onclick="handleSocialBack()">â† ä¸Šä¸€æ­¥ (è¿”å›é‡‘é‘°/é—œå¡)</div></div>
        <h1>SOUL SYNC</h1>
        <div class="subtitle" id="social-stage-title">ä»»å‹™äºŒï¼šç¬¬ 1 éšæ®µåŒæ­¥</div>
        
        <div class="game-progress-bar" id="game-progress">
            <div class="game-dot" id="dot-0"></div>
            <div class="game-dot" id="dot-1"></div>
            <div class="game-dot" id="dot-2"></div>
        </div>

        <div class="crystal-card">
            <div class="info-row">
                <div class="crystal-info"><div class="info-tag">GROUP</div><div class="info-val" id="out-group">---</div></div>
                <div class="crystal-info"><div class="info-tag">MBTI</div><div class="info-val" id="out-mbti">---</div></div>
            </div>
            <div class="info-row">
                <div class="crystal-info"><div class="info-tag">SUBJECT</div><div class="info-val" id="out-subject">---</div></div>
                <div class="crystal-info"><div class="info-tag">SIBLINGS</div><div class="info-val" id="out-sibling">---</div></div>
            </div>
            <div class="info-row">
                <div class="crystal-info"><div class="info-tag">LANGUAGES</div><div class="info-val" id="out-language">---</div></div>
                <div class="crystal-info"><div class="info-tag">BACKGROUND</div><div class="info-val" id="out-extra">---</div></div>
            </div>
        </div>

        <div class="game-box" id="social-mission-txt">æ­£åœ¨è¼‰å…¥ä»»å‹™...</div>

        <button class="btn-cta" id="next-stage-btn" onclick="nextSocialStep()">å®ŒæˆæŒ‘æˆ°ï¼Œå‰å¾€ä¸‹ä¸€é—œ</button>
    </div>

    <!-- ä»»å‹™ä¸‰ï¼šæˆ°ä½åˆ†é… -->
    <div id="screen-3" class="screen">
        <div class="nav-bar"><div class="btn-back" onclick="navTo(2)">â† è¿”å›åŒæ­¥ä»»å‹™æœ€å¾Œä¸€é—œ</div></div>
        <h1>STRATEGIC ARRAY</h1>
        <div class="subtitle">ä»»å‹™ä¸‰ï¼šåˆ†é…æˆ°ç•¥ä½ç½®</div>
        <p style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 12px;">è«‹è§€å¯Ÿçµ„å“¡ç‰¹è³ªå¾Œï¼Œæ¯äººèªé ˜ä¸€å€‹ä½ç½®ï¼š</p>
        
        <div class="role-grid">
            <div class="role-item" onclick="pickRole('causal', this)"><span class="role-name">ğŸ•µï¸ å› æœæ´å¯Ÿæ‰‹</span><span class="role-desc">æä¾›æ™‚ç©ºæ•¸æ“šã€‚</span></div>
            <div class="role-item" onclick="pickRole('logic', this)"><span class="role-name">ğŸ“Š æ•¸æ“šé‚è¼¯å®˜</span><span class="role-desc">æ‹†è§£æ•¸æ“šæ¼æ´ã€‚</span></div>
            <div class="role-item" onclick="pickRole('innovation', this)"><span class="role-name">ğŸš€ å‰µæ–°è§£ç¢¼å“¡</span><span class="role-desc">å°‹æ‰¾éš±è—é—œè¯ã€‚</span></div>
            <div class="role-item" onclick="pickRole('leadership', this)"><span class="role-name">ğŸ‘‘ æˆ°ç•¥æŒ‡æ®å®˜</span><span class="role-desc">æ•´åˆå…¨å“¡ç¢ç‰‡ã€‚</span></div>
        </div>

        <button class="btn-cta" id="start-mission-btn" onclick="startRounds()" disabled>é€²å…¥æœ€çµ‚å› æœåµéŒ¯</button>
    </div>

    <!-- ä»»å‹™å››ï¼šå› æœåµéŒ¯ -->
    <div id="screen-4" class="screen">
        <div class="nav-bar"><div class="btn-back" onclick="handleMissionBack()">â† è¿”å›ä¸Šä¸€æ­¥ (æˆ°ä½/é¡Œç›®)</div></div>
        <div id="round-info" style="font-family:'Orbitron'; color:var(--p1); font-size:0.7rem; margin-bottom:8px;">MISSION ROUND 1/3</div>
        
        <div class="case-box">
            <div class="case-tag">DATASTREAM FEED</div>
            <div class="case-txt" id="case-content-txt">è¼‰å…¥æ•¸æ“šä¸­...</div>
        </div>

        <div class="fragment-hint" id="role-fragment">æ­£åœ¨ç²å–æƒ…å ±ç¢ç‰‡...</div>

        <div id="quiz-area">
            <p style="font-size: 0.8rem; color: var(--gold); font-weight: 900; margin-bottom: 8px;">ğŸ“¢ å”¸å‡ºç·šç´¢ï¼Œé”æˆåœ˜éšŠå…±è­˜å¾Œæäº¤ï¼š</p>
            <div id="opt-box"></div>
            <button class="btn-cta" id="btn-submit" onclick="submitAns()" disabled>ç¢ºèªåœ˜éšŠå…±è­˜ä¸¦æäº¤</button>
        </div>
    </div>

    <!-- çµ‚ç«  -->
    <div id="screen-final" class="screen">
        <h2 style="font-family:'Orbitron'; color:#fff;">QUEST COMPLETED</h2>
        <div style="font-size: 3.2rem; color: var(--gold); font-weight: 900; margin: 15px 0;" id="final-pts">0</div>
        <div class="quest-card" style="border-color: var(--p1);">
            <span class="subtitle" style="margin-bottom: 5px; display: block; font-size: 0.6rem;">åœ˜éšŠé­”æ³•å…±é³´è©•åƒ¹</span>
            <div id="eval-text-final" style="font-size: 0.95rem; color: #fff; line-height: 1.5; font-weight: 700;">---</div>
        </div>
        <button class="btn-cta" onclick="resetGame()">é‡æ–°å•Ÿå‹•ä¸–ç•Œç·š</button>
    </div>
</div>

<script>
    let myIdentity = {};
    let myRole = null;
    let currentIdx = 0;
    let totalScore = 0;
    let chosenIdx = null;
    let socialStep = 0;
    let sessionSocialMissions = [];

    const missionMasterPool = [
        /* Group A (0-2) */
        "æ‰¾å‡ºçµ„å…§åŒæ¨£åƒåŠ éã€Œé‹å‹•ç¤¾åœ˜ã€çš„äººï¼Œå…©äººä¸€èµ·è¨­è¨ˆä¸€å€‹ 3 ç§’é˜çš„ã€åœ˜éšŠå‹åˆ© Poseã€å±•ç¤ºçµ¦å…¨çµ„ï¼",
        "å‘çµ„å“¡åˆ†äº«ä½ çš„ã€Œèˆˆè¶£ã€ï¼Œæ‰¾å‡ºæ„›å¥½æœ€è®“ä½ é©šè¨çš„äººï¼Œå…©äººå®Œæˆä¸€å€‹ã€èŠ±å¼æ“ŠæŒåŠ è½‰åœˆã€å‹•ä½œï¼",
        "æ‰¾å‡ºçµ„å…§ã€Œæœ€æ“…é•·ç§‘ç›®ã€è·Ÿä½ æœ€æ¥è¿‘çš„äººï¼Œå…©äººæ“Šæ‹³ç´„å®šä»Šå¤©è¦äº’ç›¸ Carryï¼",
        /* Group B (3-5) */
        "å°‹æ‰¾çµ„å…§åŒæ¨£ã€Œå­¸éæ¨‚å™¨ã€çš„äººï¼Œå…©äººä¸€èµ·åšå‡º 5 ç§’é˜çš„ã€ç©ºæ°£å‰ä»– vs ç©ºæ°£é¼“ã€åˆå¥å‹•ä½œï¼",
        "æ‰¾å‡ºçµ„å…§ã€Œæœƒè¬›èªè¨€æ•¸é‡ã€ç›¸åŒçš„äººï¼Œä¸€èµ·ç”¨ä½ å€‘æœ€å¼·çš„å¤–èªèªªå‡ºï¼šã€å› æœå³æ˜¯çœŸç›¸ï¼ã€",
        "çµ±è¨ˆçµ„å…§ 5 ä½æˆå“¡çš„æœ€å²å®³ç§‘ç›®ï¼Œé¸å‡ºæœ€å¼·ã€Œæ–‡ç†è…¦åŠ›çµ„åˆã€ï¼Œè®“ä»–å€‘å±•ç¤ºã€å¤§è…¦é€£ç·šã€Poseï¼",
        /* Group C (6-8) */
        "æ‰¾å‡ºçµ„å…§ã€Œæ‰‹è¶³æ’è¡Œã€å®Œå…¨ç›¸åŒçš„äººï¼ˆä¾‹å¦‚éƒ½æ˜¯è€å¤§ï¼‰ï¼Œå…©å€‹äººå°å…¨çµ„åˆ†äº«ç•¶è€å¤§çš„è¾›é…¸å²ï¼",
        "æ‰¾å‡ºçµ„å…§å±…ä½åœ°é›¢å ´åœ°ã€Œæœ€é ã€çš„å¤¥ä¼´ï¼Œå¤§å®¶è¼ªæµå°ä»–èªªå‡ºä¸€å¥é—œæ–¼ä»–å®¶é„‰çš„è®šç¾ï¼",
        "å°‹æ‰¾çµ„å…§ MBTI é¡å‹è·Ÿè‡ªå·±ã€Œæœ€äº’è£œã€çš„äººï¼ˆå¦‚ I vs Eï¼‰ï¼Œå…©äººèƒŒå°èƒŒé»é ­ä¸‰æ¬¡å–Šã€åˆä½œæ„‰å¿«ã€ï¼",
        /* Group D (9-11) */
        "æ‰¾å‡ºçµ„å…§æ›¾åƒåŠ éã€Œåº·è¼”ã€å‰ä»–æˆ–ç†±èˆç¤¾ã€çš„ç†±è¡€åˆ†å­ï¼Œè«‹ä»–å¸¶é ˜å…¨çµ„åšå‡ºä¸€å€‹æœ€æœ‰èƒ½é‡çš„å‹•ä½œï¼",
        "åˆ†äº«ä¸€å€‹ã€Œåªæœ‰é€™çµ„å¤¥ä¼´æ‰çŸ¥é“çš„ç§˜å¯†ç‰¹è‰²ã€ï¼ˆä¾‹ï¼šæˆ‘ä¸å–å’–å•¡ï¼‰ï¼Œæ‰¾å‡ºæœ€æœ‰å…±é³´çš„äººæ¯”å¿ƒï¼",
        "å…¨çµ„å…±åŒè¨è«–ä¸€å€‹ç¬¦åˆ 5 äººå…±åŒç‰¹è³ªçš„ã€Œå°çµ„æˆ°éšŠåç¨±ã€ï¼Œç”±å¤§å®¶ä¸€èµ·å¤§è²å–Šå‡ºä¾†ï¼"
    ];

    const database = [
        { q: "ç•°å¸¸ï¼šå†°æ·‡æ·‹éŠ·é‡è¶Šé«˜æ™‚ï¼Œæººæ°´äººæ•¸ä¹Ÿè¶Šé«˜ã€‚", 
          frags: { causal: "ğŸ•µï¸ æ´å¯Ÿæ‰‹ï¼šè³‡æ–™é¡¯ç¤ºæººæ°´é«˜å³°æœŸçš†é›†ä¸­åœ¨ 7-8 æœˆå¤å­£ï¼Œä¸”é‚£æ™‚æ°£æº«å¹³å‡ 34 åº¦ã€‚", logic: "ğŸ“Š é‚è¼¯å®˜ï¼šåˆ†æç™¼ç¾å†°æ·‡æ·‹æˆåˆ†åˆ†æé¡¯ç¤ºï¼Œä¸¦æ²’æœ‰ä»»ä½•æœƒå°è‡´ç”Ÿç†å¤±æ§çš„ç‰©è³ªã€‚", innovation: "ğŸš€ è§£ç¢¼å“¡ï¼šç›£æ¸¬ç™¼ç¾é˜²æ›¬ä¹³éŠ·é‡ä¹Ÿåœ¨æ­¤æ™‚åŒæ­¥é£†å‡ï¼Œé€™æ˜¯ä¸€ç¨®é€±æœŸæ€§ç¾è±¡ã€‚", leadership: "ğŸ‘‘ æŒ‡æ®å®˜ï¼šå½™æ•´å¤§å®¶ç·šç´¢ã€‚çœŸçš„æ˜¯å› æœå—ï¼Ÿé‚„æ˜¯æœ‰å¦ä¸€å€‹ã€Œéš±è—è®Šå› ã€å½±éŸ¿å…©è€…ï¼Ÿ" },
          opts: ["å†°æ·‡æ·‹æœƒæ¶ˆè€—é«”åŠ›", "å¤å­£é«˜æº« (éš±è—ä¸»å› )", "æ¸¸æ³³æ± åŒ…è£æ±¡æŸ“"], win: 1 },
        { q: "ç•°å¸¸ï¼šå®¶è£¡æ›¸ç±æ•¸é‡è¶Šå¤šçš„å°å­©ï¼Œå­¸æ¥­æˆç¸¾é€šå¸¸è¶Šå¥½ã€‚", 
          frags: { causal: "ğŸ•µï¸ æ´å¯Ÿæ‰‹ï¼šè¿½è¹¤å¯¦é©—ç™¼ç¾ï¼Œå–®ç´”æŠŠæ›¸è²·å›å®¶è€Œä¸å»é–±è®€ï¼Œæˆç¸¾ä¸¦ä¸æœƒæå‡ã€‚", logic: "ğŸ“Š é‚è¼¯å®˜ï¼šæ›¸ç±å¤šå¯¡é€šå¸¸åæ‡‰äº†å®¶é•·å°æ–¼æ•™è‚²ç’°å¢ƒçš„æŠ•å…¥åº¦èˆ‡è³‡æºå¤šå¯¡ã€‚", innovation: "ğŸš€ è§£ç¢¼å“¡ï¼šè§€å¯Ÿç™¼ç¾é€™äº›å®¶åº­é€šå¸¸å…·å‚™æ›´å®Œå–„çš„å­¸ç¿’ç©ºé–“èˆ‡é«˜å“è³ªé™ªä¼´ã€‚", leadership: "ğŸ‘‘ æŒ‡æ®å®˜ï¼šæ˜¯æ›¸æœ¬æœ¬èº«åœ¨ç™¼å…‰ï¼Ÿé‚„æ˜¯ã€å®¶åº­ç’°å¢ƒè³‡æºã€æ‰æ˜¯å½±éŸ¿æˆç¸¾çš„é—œéµï¼Ÿ" },
          opts: ["æ›¸æœ¬é‡‹æ”¾æ™ºæ…§é »ç‡", "å®¶åº­èƒŒæ™¯èˆ‡æ•™è‚²è³‡æº", "æ›¸æ¶é‡é‡å¢åŠ æ™ºå•†"], win: 1 },
        { q: "ç•°å¸¸ï¼šé†«é™¢è£¡ç©¿ç™½è¢çš„äººè¶Šå¤šï¼Œç•¶å¤©ç—…æ‚£æ­»äº¡äººæ•¸é€šå¸¸è¶Šé«˜ã€‚", 
          frags: { causal: "ğŸ•µï¸ æ´å¯Ÿæ‰‹ï¼šæ™‚é–“åºåˆ—é¡¯ç¤ºï¼Œå¤§éƒ¨åˆ†æ­»äº¡æ¡ˆä¾‹éƒ½ç™¼ç”Ÿåœ¨æ€¥è¨ºå®¤æˆ–é‡ç—‡åŠ è­·ç—…æˆ¿(ICU)ã€‚", logic: "ğŸ“Š é‚è¼¯å®˜ï¼šçµ±è¨ˆé¡¯ç¤ºåŠ è­·ç—…æˆ¿é…ç½®çš„é†«å¸«èˆ‡è­·ç†å¸«ï¼ˆç©¿ç™½è¢è€…ï¼‰æ¯”ä¾‹æ˜¯æœ€é«˜çš„ã€‚", innovation: "ğŸš€ è§£ç¢¼å“¡ï¼šæ¯”è¼ƒç™¼ç¾ï¼Œåœ¨æ™®é€šé–€è¨ºï¼Œé›–ç„¶ä¹Ÿæœ‰ç™½è¢ï¼Œä½†æ­»äº¡ç‡æ¥è¿‘æ–¼é›¶ã€‚", leadership: "ğŸ‘‘ æŒ‡æ®å®˜ï¼šç¦æ­¢ç™½è¢èƒ½æ•‘äººå—ï¼Ÿé‚„æ˜¯ç™½è¢å¤šçš„åœ°æ–¹æ˜¯å› ç‚ºç—…æƒ…æœ¬ä¾†å°±å±éšªï¼Ÿ" },
          opts: ["ç™½è¢æœƒå°è‡´ç—…æ‚£å£“åŠ›", "é‡ç—‡å¯†åº¦èˆ‡ç–¾ç—…åš´é‡åº¦", "é†«è­·äººå“¡é«”æº«éé«˜"], win: 1 }
    ];

    function navTo(n) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const target = document.getElementById(`screen-${n}`);
        if(target) target.classList.add('active');
        if(n === 2 && sessionSocialMissions.length === 0) initSocialGame();
    }

    function handleSocialBack() {
        if (socialStep > 0) {
            socialStep--;
            updateSocialUI();
        } else {
            navTo(1);
        }
    }

    function handleMissionBack() {
        if (currentIdx > 0) {
            currentIdx--;
            renderRound();
        } else {
            navTo(3);
        }
    }

    function initSocialGame() {
        socialStep = 0;
        const group = myIdentity.group;
        let startIdx = group === 'B' ? 3 : (group === 'C' ? 6 : (group === 'D' ? 9 : 0));
        sessionSocialMissions = missionMasterPool.slice(startIdx, startIdx + 3);
        updateSocialUI();
    }

    function nextSocialStep() {
        if(socialStep < 2) { socialStep++; updateSocialUI(); } 
        else { navTo(3); }
    }

    function updateSocialUI() {
        const titles = ["ç¬¬ä¸€éšæ®µåŒæ­¥", "ç¬¬äºŒéšæ®µåŒæ­¥", "ç¬¬ä¸‰éšæ®µåŒæ­¥"];
        document.getElementById('social-stage-title').innerText = `ä»»å‹™äºŒï¼š${titles[socialStep]}`;
        document.getElementById('social-mission-txt').innerText = `ğŸ² ç¬¬ ${socialStep + 1} é—œï¼š${sessionSocialMissions[socialStep]}`;
        document.querySelectorAll('.game-dot').forEach((dot, idx) => {
            idx <= socialStep ? dot.classList.add('fill') : dot.classList.remove('fill');
        });
        document.getElementById('next-stage-btn').innerText = socialStep === 2 ? "åŒæ­¥é”æˆï¼Œè§£é–æˆ°ä½" : "å®ŒæˆæŒ‘æˆ°ï¼Œä¸‹ä¸€é—œ";
    }

    function finishTask1() {
        const name = document.getElementById('in-name').value;
        const mbti = document.getElementById('in-mbti').value;
        if(!name || !mbti) { alert("è«‹å¡«å¯«å§“åèˆ‡ MBTIï¼"); return; }
        myIdentity = { 
            name, mbti, group: document.getElementById('in-group').value,
            subject: document.getElementById('in-subject').value || "æœªå¡«å¯«", 
            sibling: document.getElementById('in-sibling').value, 
            language: document.getElementById('in-language').value,
            hobby: document.getElementById('in-hobby').value || "æœªå¡«å¯«", 
            motive: document.getElementById('in-motive').value || "æœªå¡«å¯«", 
            extra: `${document.getElementById('in-music').value} / ${document.getElementById('in-club').value}` 
        };
        for(let key in myIdentity) { let el = document.getElementById(`out-${key}`); if(el) el.innerText = myIdentity[key]; }
        sessionSocialMissions = [];
        navTo(2);
    }

    function pickRole(r, el) {
        myRole = r;
        document.querySelectorAll('.role-item').forEach(i => i.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('start-mission-btn').disabled = false;
    }

    function startRounds() { currentIdx = 0; totalScore = 0; navTo(4); renderRound(); }

    function renderRound() {
        const data = database[currentIdx];
        chosenIdx = null;
        document.getElementById('round-info').innerText = `ROUND ${currentIdx + 1}/3`;
        document.getElementById('case-content-txt').innerText = data.q;
        document.getElementById('role-fragment').innerText = data.frags[myRole];
        document.getElementById('btn-submit').disabled = true;
        const box = document.getElementById('opt-box');
        box.innerHTML = '';
        data.opts.forEach((t, i) => {
            const b = document.createElement('div');
            b.className = 'btn-opt';
            b.innerText = t;
            b.onclick = () => {
                document.querySelectorAll('.btn-opt').forEach(x => x.classList.remove('selected'));
                b.classList.add('selected');
                chosenIdx = i;
                document.getElementById('btn-submit').disabled = false;
            };
            box.appendChild(b);
        });
    }

    function submitAns() {
        if(chosenIdx === null) return;
        const s = document.getElementById('scanner-ui');
        s.style.display = 'flex';
        setTimeout(() => {
            s.style.display = 'none';
            const win = chosenIdx === database[currentIdx].win;
            const contentEl = document.getElementById('case-content-txt');
            if(win) { totalScore += 100; contentEl.innerHTML = "<span style='color:#2ed573'>âœ… è¨ºæ–·æ­£ç¢ºï¼</span>"; }
            else { contentEl.innerHTML = "<span style='color:#ff4757'>âŒ åµæ¸¬å¤±æ•—ï¼</span>"; }
            document.querySelectorAll('.btn-opt').forEach(b => b.style.pointerEvents = 'none');
            setTimeout(() => { 
                if(currentIdx < 2) { currentIdx++; renderRound(); } 
                else { showFinal(); }
            }, 1500);
        }, 1200);
    }

    function showFinal() {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-final').classList.add('active');
        document.getElementById('final-pts').innerText = totalScore;
        let msg = totalScore === 300 ? "è¶…å‡¡é­”æ³•å…±é³´ï¼šä½ å€‘çš„åœ˜éšŠæºé€šå®Œç¾ï¼Œé€™ä»½é»˜å¥‘æ˜¯ç ”ç™¼æœªä¾†çš„æœ€å¼·å‹•åŠ›ï¼" :
                 (totalScore >= 200 ? "æˆ°ç•¥é ˜è¢–å°çµ„ï¼šå·²å…·å‚™çœ‹ç©¿å¤§æ•¸æ“šå½è£çš„èƒ½åŠ›ï¼Œå†å¤šè·¨è·ä½äº¤æµï¼ŒçœŸç›¸æœƒæ›´æ¸…æ™°ã€‚" :
                 "åˆæ­¥è¦ºé†’éšæ®µï¼šè¨˜å¾—å¤šå‚¾è½å¤¥ä¼´æ‰‹ä¸­çš„ã€Œç¢ç‰‡ç·šç´¢ã€ï¼Œæ¯å¡Šç¢ç‰‡éƒ½æ˜¯é€šå¾€çœŸç›¸çš„å”¯ä¸€é‘°åŒ™ã€‚");
        document.getElementById('eval-text-final').innerText = msg;
    }

    // ç¬ç™¼å„ªåŒ–ï¼šæ‰‹å‹•é‡ç½®éŠæˆ²ç‹€æ…‹ï¼Œä¸ä¾è³´ reload
    window.resetGame = () => {
        // é‡ç½®è³‡æ–™
        myIdentity = {};
        myRole = null;
        currentIdx = 0;
        totalScore = 0;
        chosenIdx = null;
        socialStep = 0;
        sessionSocialMissions = [];
        
        // é‡ç½®è¼¸å…¥æ¡†
        document.querySelectorAll('input, textarea').forEach(el => el.value = "");
        document.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
        
        // é‡ç½® UI ç‹€æ…‹
        document.querySelectorAll('.role-item').forEach(i => i.classList.remove('selected'));
        document.getElementById('start-mission-btn').disabled = true;
        
        // è¿”å›ç¬¬ä¸€é 
        navTo(1);
    }
</script>
</body>
</html>